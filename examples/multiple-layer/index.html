<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>多图层示例</title>

	<style>
		#stage{
			width:820px;
			float:left;
		}
		canvas{
			background-color: #ccc;
		}
		.right-section{
			float:left;
			width:200px;
		}
		#layer canvas{
			width:190px;
		}

	</style>
</head>
<body>
<br>
<br>
<h3 style="text-align: center;">ycc图层系统示例，项目地址：<a href="https://github.com/lizhiqianduan/ycc" target="_blank">ycc github</a></h3>
<br>
<br>
<div id="stage">
	<div>绘图区 <br>（图层原本为透明色，灰色仅仅是为了显示效果）</div>
	<canvas width="800" height="600">

	</canvas>
</div>

<div class="right-section">
	<div class="ctrl">
		<button onclick="newLayer()">新建图层</button>
	</div>

	<div id="layer">
		<div>图层列表（点击可删除图层）</div>
		<hr>
	</div>
</div>

</body>
</html>


<script src="http://localhost:9000/livereload.js"></script>

<script src="../../build/ycc.js"></script>


<script>

	var stage = document.getElementById("stage").getElementsByTagName("canvas")[0];
	var layerDom = document.getElementById("layer");

	var ycc = new window.Ycc();
	ycc.bindCanvas(stage);

	newLayer();



	function newLayer() {
		var layer = ycc.layerManager.newLayer({enableEventManager:true});
		ycc.layerManager.enableEventManagerOnly(layer);
		ycc.layerManager.reRenderAllLayerToStage();
		pen();
		renderLayerToHtml();


		/**
		 * 钢笔
		 */
		function pen() {
			var startDot = [];
			var hasMoved = false;
			var ui = null;
			layer.onclick = function (e) {};
			layer.onmousedown = function (e) {
				startDot = (new Ycc.Math.Dot(e.x,e.y));
				ui = new Ycc.UI.BrokenLine({color:"red",width:3});
				ui.pointList.push(startDot);
				layer.addUI(ui);
			};
			layer.ondragging = function (e) {
				hasMoved = true;
				var moveDot = (new Ycc.Math.Dot(e.x,e.y));
				ui.pointList.push(moveDot);
				renderLayerToHtml();
				ycc.layerManager.reRenderAllLayerToStage();
			};
			layer.onmouseup = function (e) {
				if(!hasMoved) return null;
				ycc.photoManager.takePhoto();
				hasMoved = false;
			};
		}


	}

	function renderLayerToHtml() {
		for(var i=ycc.layerList.length-1;i>=0;i--){
			var layer = ycc.layerList[i];
			var canvas = document.getElementById("ycc-layer-"+layer.id);// || document.createElement("canvas");
			// 没有元素则新建dom
			if(!canvas){
				canvas = document.createElement("canvas");
				canvas.width = layer.width;
				canvas.height = layer.height;
				canvas.id = "ycc-layer-"+layer.id;
				layerDom.appendChild(canvas);
			}
			var layerYcc = new Ycc();
			layerYcc.bindCanvas(canvas);
			var newLayer = layerYcc.layerManager.newLayer({enableEventManager:true});
			layer.uiList.forEach(function (ui) {
				newLayer.addUI(ui.clone());
			});
			layerYcc.layerManager.reRenderAllLayerToStage();

			// 点击事件
			canvas.onclick = function (_ycc,_layer) {
				return function () {
					layerDom.removeChild(this);
					// 清空舞台
					_ycc.clearStage();
					// 删除图层
					_ycc.layerManager.deleteLayer(_layer);
					// 重新渲染所有图层
					_ycc.layerManager.renderAllLayerToStage();
					// 将最后一个图层设置为当前绘制图层
					_ycc.layerManager.enableEventManagerOnly(ycc.layerList[ycc.layerList.length-1]);
					// 拍照
					_ycc.photoManager.takePhoto();
					// 重新渲染图层列表
					renderLayerToHtml();
				};
			}(layerYcc,newLayer)
		}
	}



</script>