<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>简单的编辑器</title>
	<style>
		*{margin: 0;padding: 0;}
		body{
			position: relative;
			background-color: #ccc;
		}
		#canvas{
			position: relative;
			left: 50%;
			margin-left: -400px;
		}
		.ctrl{
			position: relative;
			width:800px;
			left: 50%;
			margin-left: -400px;
		}

		#photos canvas{
			width:200px;
		}
		h3{
			text-align: center;
		}
	</style>

</head>
<body>
<div>
	<br>
	<br>
	<h3>基于ycc简单的编辑器，项目地址：<a href="https://github.com/lizhiqianduan/ycc" target="_blank">ycc github</a></h3>
	<br>
	<br>
	<br>
	<div class="ctrl">
		<button onclick="goBack()">回退</button>
		&nbsp;&nbsp;
		<button onclick="zoomIn()">放大</button>
		<button onclick="zoomOut()">缩小</button>
		&nbsp;&nbsp;&nbsp;&nbsp;
		<button onclick="line()">直线</button>
		<button onclick="pen()">钢笔</button>
		<button onclick="rect()">方框</button>
		<button onclick="ellipse()">椭圆</button>
		<button onclick="gou()">勾勾</button>
		<button onclick="cross()">叉叉</button>
		<button onclick="text()">文字</button>
	</div>
	<br>

	<div id="canvas">
	</div>
	<br>
	<div id="photos"></div>
</div>

</body>
</html>
<script src="http://localhost:9000/livereload.js"></script>

<script src="../../build/ycc.js"></script>


<script>


	// 需要加载的图片资源路径和名称
	var imageResources = {
		tick:"./tick.png",
		cross:"./cross.png",
		paper:"./paper.jpg"
	};
	// 资源加载完成后，所有资源的引用
	var imageRes = null;

	// ycc实例
	var ycc = null;

	// 本例所有操作都在一个图层完成
	var layer = null;

	// 放大缩小的比例
	var scale = 1;

	// canvas初始宽度
	var originWidth = 0;

	// 加载器实例
	new Ycc.Loader().loadImageList(imageResources,function (imgs) {
		imageRes = imgs;

		// 新建渲染舞台
		var canvas = document.createElement("canvas");
		canvas.width = imageRes.paper.width;
		canvas.height = imageRes.paper.height;
		originWidth = canvas.width;
		document.getElementById("canvas").appendChild(canvas);


		ycc = new Ycc();
		ycc.bindCanvas(canvas);
		layer = ycc.layerManager.newLayer({name:"试卷图层"});
		layer.enableEventManager = true;

		layer.onclick = function (e) {
			console.log(this,e);
		};

//		layer.ui.image(imgs.paper,[0,0]);
		layer.addUI(new Ycc.UI.Image({
			rect:new Ycc.Math.Rect(0,0,imgs.paper.width,imgs.paper.height),
			res:imgs.paper
		}));
		ycc.layerManager.reRenderAllLayerToStage();
		ycc.photoManager.takePhoto();

	});





	function showPhotoToHtml() {
		var dom = document.getElementById("photos");
		dom.innerHTML = "";
		for(var i = 0;i<ycc.photoManager._photos.length;i++){
			var canvas = document.createElement("canvas");
			canvas.width = 800;
			canvas.height = 600;
			canvas.create_time = ycc.photoManager._photos[i].createTime;
			var ctx = canvas.getContext('2d');
			ctx.putImageData(ycc.photoManager._photos[i].imageData,0,0);
			dom.appendChild(canvas);
		}
	}


	/**
	 * 放大
	 */
	function zoomIn() {
		scale+=0.1;

//		ycc.canvasDom.width = ycc.canvasDom.width*scale;
//		ycc.canvasDom.height = ycc.canvasDom.height*scale;
//		ycc.layerManager.reRenderAllLayerToStage();

		ycc.canvasDom.style.width = originWidth*scale+"px";
		ycc.layerList[0].uiList[0].scaleX = scale;
		ycc.layerList[0].uiList[0].scaleY = scale;
		ycc.layerManager.reRenderAllLayerToStage();

//		ycc.canvasDom.style.width = originWidth*scale+"px";
	}

	/**
	 * 缩小
	 */
	function zoomOut() {
		scale-=0.1;
		ycc.canvasDom.style.width = originWidth*scale+"px";
	}


	/**
	 * 画直线
	 */
	function line() {
		var ui = null;

		var hasDragged = false;
		layer.onclick = function (e) { };
		layer.onmousedown = function (e) {
			ui = new Ycc.UI.Line();
			layer.addUI(ui);
		};
		layer.ondragging = function (e) {
			hasDragged = true;
			ui.start = translateDotByScale(Ycc.Event.mouseDownEvent);
			ui.end = translateDotByScale(e);
			ycc.layerManager.reRenderAllLayerToStage();

		};
		layer.onmouseup = function (e) {
			ui = null;
			if(!hasDragged) return null;
			ycc.photoManager.takePhoto();
			showPhotoToHtml();
			hasDragged = false;
		};
	}


	/**
	 * 钢笔
	 */
	function pen() {
		var startDot = [];
		var hasMoved = false;
		var ui = null;
		layer.onclick = function (e) {};
		layer.onmousedown = function (e) {
			startDot = translateDotByScale(new Ycc.Math.Dot(e.x,e.y));
			ui = new Ycc.UI.BrokenLine({color:"red",width:3});
			ui.pointList.push(startDot);
			layer.addUI(ui);
		};
		layer.ondragging = function (e) {
			hasMoved = true;
			var moveDot = translateDotByScale(new Ycc.Math.Dot(e.x,e.y));
			ui.pointList.push(moveDot);

			ycc.layerManager.reRenderAllLayerToStage();
//			startDot = moveDot;
		};
		layer.onmouseup = function (e) {
			if(!hasMoved) return null;
			ycc.photoManager.takePhoto();
			showPhotoToHtml();
			hasMoved = false;
		};
	}


	/**
	 * 画方框
	 */
	function rect() {
		var hasDragged = false;
		var rect;
		layer.onclick = function (e) {};
		layer.onmousedown = function () {
			rect = new Ycc.UI.Rect({
				fill:false,
				color:"red"
			});
			layer.addUI(rect);
		};
		layer.ondragging = function (e) {
			hasDragged = true;
			var startDot = new Ycc.Math.Dot(Ycc.Event.mouseDownEvent.x,Ycc.Event.mouseDownEvent.y);
			var endDot = new Ycc.Math.Dot(e.x,e.y);
			rect.rect = new Ycc.Math.Rect(startDot.x,startDot.y,endDot.x-startDot.x,endDot.y-startDot.y);
			ycc.layerManager.reRenderAllLayerToStage();
		};
		layer.onmouseup = function (e) {
			if(!hasDragged) return null;
			ycc.photoManager.takePhoto();
			showPhotoToHtml();
			hasDragged = false;
		};
	}

	/**
	 * 画圈
	 * @param hasRotate	{Boolean}	是否允许椭圆旋转
	 */
	function ellipse(hasRotate) {
		var hasDragged = false;


		var ui;
		layer.onclick = function (e) {};
		layer.onmousedown = function () {
			ui = new Ycc.UI.Ellipse();
			layer.addUI(ui);
		};


		layer.onclick = function (e) {};

		layer.ondragging = function (e) {
			hasDragged = true;
			var startDot = translateDotByScale(new Ycc.Math.Dot(Ycc.Event.mouseDownEvent.x,Ycc.Event.mouseDownEvent.y));
			var endDot = translateDotByScale(new Ycc.Math.Dot(e.x,e.y));

			ui.point.x = (startDot.x+endDot.x)/2;
			ui.point.y = (startDot.y+endDot.y)/2;
			ui.width = Math.abs(endDot.x - startDot.x)/2;
			ui.height = Math.abs(endDot.y - startDot.y)/2;
			ui.angle = 0;
			ycc.layerManager.reRenderAllLayerToStage();

		};
		layer.onmouseup = function (e) {
			if(!hasDragged) return null;
			ycc.photoManager.takePhoto();
			showPhotoToHtml();
			hasDragged = false;
		};
	}

	/**
	 * 画勾
	 */
	function gou() {
		layer.ondragging = function (e) {};
		layer.onmouseup = function (e) {};
		layer.onclick = function (e) {
			var endDot = translateDotByScale(new Ycc.Math.Dot(e.x-22,e.y-56));
			layer.addUI(new Ycc.UI.Image({res:imageRes.tick,rect:new Ycc.Math.Rect(endDot.x,endDot.y,64,64),fillMode:"scale"}));
			ycc.layerManager.reRenderAllLayerToStage();
			ycc.photoManager.takePhoto();
			showPhotoToHtml();
		}
	}

	/**
	 * 画叉
	 */
	function cross(){
		layer.ondragging = function (e) {};
		layer.onmouseup = function (e) {};
		layer.onclick = function (e) {
			var endDot = translateDotByScale(new Ycc.Math.Dot(e.x-30,e.y-38));
			layer.addUI(new Ycc.UI.Image({res:imageRes.cross,rect:new Ycc.Math.Rect(endDot.x,endDot.y,64,64),fillMode:"scale"}));
			ycc.layerManager.reRenderAllLayerToStage();
			ycc.photoManager.takePhoto();
			showPhotoToHtml();
		}
	}


	function text() {
		layer.ondragging = function (e) {};
		layer.onmouseup = function (e) {};
		layer.onclick = function (e) {
			var endDot = translateDotByScale([e.x,e.y]);
			layer.addUI(new Ycc.UI.MultiLineText({content:"1111111111111111111\n222222222222222222222",rect:new Ycc.Math.Rect(e.x,e.y,500,0)}));
			ycc.layerManager.reRenderAllLayerToStage();
			ycc.photoManager.takePhoto();
			showPhotoToHtml();
		}

	}



	/**
	 * 点击回退
	 */
	function goBack() {
		layer.uiList.pop();
		layer.clear();
		var photos = ycc.photoManager.getHistoryPhotos();
		if(photos.length>=2){
			var photo = photos[photos.length-2];
			ycc.photoManager.showPhoto(photo);
			ycc.photoManager.delPhotoById(photo.id);
			showPhotoToHtml();
		}
	}


	/**
	 * 变换一个点，根据缩放比例变化一个点的坐标
	 * @param dot
	 * @param dot.x
	 * @param dot.y
	 * @returns {Ycc.Math.Dot}
	 */
	function translateDotByScale(dot){
//		var res = [0,0];
//		res[0]= dot[0]/scale;
//		res[1]= dot[1]/scale;
//		return res;

		var res = {x:0,y:0};
		res.x= dot.x/scale;
		res.y= dot.y/scale;
		return res;
	}










</script>