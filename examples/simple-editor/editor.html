<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>简单的编辑器</title>
	<style>
		*{margin: 0;padding: 0;}
		body{
			position: relative;
			background-color: #ccc;
		}
		#canvas{
			position: relative;
			left: 50%;
			margin-left: -400px;
		}
		.ctrl{
			position: relative;
			width:800px;
			left: 50%;
			margin-left: -400px;
		}

		#photos canvas{
			width:200px;
		}
	</style>

</head>
<body>
<div>
	<canvas id="canvas" width="800" height="600">
		你的浏览器太古老了...
	</canvas>


	<div class="ctrl">
		<button onclick="goBack()">回退</button>
		&nbsp;&nbsp;&nbsp;&nbsp;
		<button onclick="line()">直线</button>
		<button onclick="pen()">钢笔</button>
		<button onclick="rect()">方框</button>
		<button onclick="ellipse()">椭圆</button>
		<button onclick="pen()">勾勾</button>
		<button onclick="pen()">叉叉</button>
	</div>

	<img src="" alt="">

	<div id="photos"></div>
</div>

</body>
</html>
<script src="http://localhost:9000/livereload.js"></script>

<script src="../../src/Ycc.class.js"></script>
<script src="../../src/Ycc.utils.js"></script>
<script src="../../src/Ycc.Config.class.js"></script>
<script src="../../src/Ycc.UI.class.js"></script>
<script src="../../src/Ycc.PhotoManager.class.js"></script>
<script src="../../src/Ycc.EventManager.class.js"></script>

<script src="../../src/Ycc.init.js"></script>


<script>
	var canvas = document.getElementById("canvas");
	var ycc = new Ycc(canvas);
	ycc.photoManager.takePhoto();

	ycc.eventManager.onmousedown = function (e) {
		console.log(e);
	};

	ycc.eventManager.ondragging = function (e) {
		console.log(e);
	};
	ycc.eventManager.onmousemove = function (e) {
//		console.log(e);
	};
	ycc.eventManager.onmouseup = function (e) {
		console.log(e);
	};


	//ycc.config.setXXX();
	//ycc.start();







	function showPhotoToHtml() {
		var dom = document.getElementById("photos");
		dom.innerHTML = "";
		for(var i = 0;i<ycc.photoManager._photos.length;i++){
			var canvas = document.createElement("canvas");
			canvas.width = 800;
			canvas.height = 600;
			var ctx = canvas.getContext('2d');
			ctx.putImageData(ycc.photoManager._photos[i].imageData,0,0);
			dom.appendChild(canvas);
		}
	}


	/**
	 * 画直线
	 */
	function line() {
		var hasDragged = false;
		ycc.eventManager.ondragging = function (e) {
			hasDragged = true;
			var endDot = [e.x,e.y];
			ycc.photoManager.showLastPhoto();
			ycc.ui.line([ycc.eventManager.mouseDownEvent.x,ycc.eventManager.mouseDownEvent.y],endDot);
		};
		ycc.eventManager.onmouseup = function (e) {
			if(!hasDragged) return null;
			ycc.photoManager.takePhoto();
			showPhotoToHtml();
			hasDragged = false;
		};
	}


	/**
	 * 钢笔
	 */
	function pen() {
		var startDot = [];
		var hasMoved = false;

		ycc.eventManager.onmousedown = function (e) {
			startDot = [e.x,e.y];
		};
		ycc.eventManager.ondragging = function (e) {
			hasMoved = true;
			var moveDot = [e.x,e.y];
			ycc.ui.line(startDot,moveDot);
			startDot = moveDot;
		};
		ycc.eventManager.onmouseup = function (e) {
			if(!hasMoved) return null;
			ycc.photoManager.takePhoto();
			showPhotoToHtml();
			hasMoved = false;
		};
	}


	/**
	 * 画方框
	 */
	function rect() {
		var hasDragged = false;
		ycc.eventManager.ondragging = function (e) {
			hasDragged = true;
			var startDot = [ycc.eventManager.mouseDownEvent.x,ycc.eventManager.mouseDownEvent.y];
			var endDot = [e.x,e.y];
			ycc.photoManager.showLastPhoto();
			ycc.ui.rect(startDot,endDot);
		};
		ycc.eventManager.onmouseup = function (e) {
			if(!hasDragged) return null;
			ycc.photoManager.takePhoto();
			showPhotoToHtml();
			hasDragged = false;
		};
	}

	/**
	 * 画圈
	 * @param hasRotate	{Boolean}	是否允许椭圆旋转
	 */
	function ellipse(hasRotate) {
		var hasDragged = false;
		ycc.eventManager.ondragging = function (e) {
			hasDragged = true;
			var startDot = [ycc.eventManager.mouseDownEvent.x,ycc.eventManager.mouseDownEvent.y];
			var endDot = [e.x,e.y];

			var entryPoint = [0,0];
			var width = 0;
			var height = 0;
			var rotateAngle = 0;
			if(hasRotate){
				entryPoint = [(startDot[0]+endDot[0])/2,(startDot[1]+endDot[1])/2];
				width = Math.pow(Math.pow(startDot[0]-endDot[0],2)+Math.pow(startDot[1]-endDot[1],2),0.5)/2;
				height = 30;
				rotateAngle = Math.acos((endDot[0]-startDot[0])/width/2)*180/Math.PI;
				if(endDot[1]-startDot[1]<=0) rotateAngle = -1*rotateAngle;
			}else{
				entryPoint = [(startDot[0]+endDot[0])/2,(startDot[1]+endDot[1])/2];
				width = Math.abs(endDot[0] - startDot[0])/2;
				height = Math.abs(endDot[1] - startDot[1])/2;
				rotateAngle = 0;
			}
			console.log(entryPoint);
			ycc.photoManager.showLastPhoto();
			ycc.ui.ellipse(entryPoint,width,height,rotateAngle);
		};
		ycc.eventManager.onmouseup = function (e) {
			if(!hasDragged) return null;
			ycc.photoManager.takePhoto();
			showPhotoToHtml();
			hasDragged = false;
		};
	}




	function goBack() {
		var photos = ycc.photoManager.getHistoryPhotos();
		if(photos.length>=2){
			var photo = photos[photos.length-2];
			ycc.photoManager.showPhoto(photo);
			ycc.photoManager.delPhotoById(photo.id);
			showPhotoToHtml();
		}
	}








</script>